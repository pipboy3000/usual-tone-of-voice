計画書：Voice-to-Codex（macOS メニューバー常駐）

Codex CLIを想定しているが、これはclaude code cliやgemini cliでも使えるようにすること

0. ゴール
	•	ホットキーで録音開始/停止
	•	Whisper（ローカル or API）で文字起こし
	•	起こしたテキストを Codex CLI に渡して実行できる
	•	失敗時も「何が起きたか」わかる（ログ/通知）

⸻

1. 想定ユーザーフロー（v1）
	1.	ターミナルで codex を使う準備（どちらか）
	•	A案：アプリが codex を直接起動して実行までやる
	•	B案：アプリはテキスト生成まで、ターミナルへ貼り付け（ユーザーが Enter）
	2.	ホットキー押下で録音開始（メニューバーアイコン状態変化）
	3.	再度ホットキーで録音停止
	4.	文字起こし → プロンプト整形 → Codexへ渡す（A or B）
	5.	成功通知（短いトースト/通知）

※ v1は B案（貼り付け） から始めると堅い。ターミナル操作の自動実行は権限と事故リスクが増える。

⸻

2. 実装方式（Codex CLI連携の選択肢）

B案（推奨v1）：フォーカス中の入力へ貼り付け
	•	文字起こし結果をクリップボードへ
	•	そのまま「ペースト」または「タイピング注入」
	•	使い方：ターミナルで codex を起動して入力待ちにしておく

メリット：安全・実装が軽い
デメリット：Enter はユーザー操作

A案（v2）：アプリ側で codex を起動し、プロンプトを渡して実行
	•	Process() で codex を起動
	•	stdin にプロンプトを流す
	•	stdout をアプリに表示（簡易ログビュー）

メリット：完全ハンズフリーに近づく
デメリット：環境依存（PATH）、権限、プロンプト注入事故のケアが必要

⸻

3. 機能要件（MVP）

必須
	•	メニューバー常駐（Dock非表示）
	•	録音開始/停止
	•	文字起こし（CLI or API）
	•	出力先：クリップボード＋自動ペースト（どちらか）
	•	エラー表示（通知 + 直近ログ）

余裕があれば
	•	プロンプト整形（フィラー除去、箇条書き化、命令文化）
	•	モード切替（Codex向け / Claude向け / 汎用）
	•	履歴（直近10件だけ）

⸻

4. 非機能要件
	•	体感レイテンシ：停止後 2〜5秒を目標（APIならもっと速い）
	•	ローカル音声ファイルは自動削除（設定で保持も可）
	•	個人利用前提：設定は最小（3〜5項目）

⸻

5. アーキテクチャ概要（モジュール分割）
	•	AppShell：メニューバーUI、状態表示、設定
	•	Recorder：AVAudioEngine で録音、WAV/PCM生成
	•	Transcriber：Whisper実行（CLI / API のStrategy）
	•	PromptNormalizer：整形（任意）
	•	Dispatcher：出力（Clipboard / Paste / CodexRunner）
	•	Logger：リングバッファ + 書き出し（任意）

⸻

6. 重要な権限・OS機能
	•	マイク権限：必須
	•	自動ペースト/入力注入をやるなら：
	•	アクセシビリティ権限（キーボードイベント注入）
	•	もしくは「コピーしたので Cmd+V してね」で逃げる（v1向き）

⸻

7. 設定項目（最小）
	•	ホットキー（デフォルト：⌥Space など）
	•	出力先：
	•	クリップボードのみ / クリップボード+自動ペースト
	•	文字起こし：
	•	Whisper CLI / Whisper API
	•	プロンプト整形：ON/OFF（v1はOFFでも良い）

⸻

8. プロンプト整形仕様（v1.5）
	•	目的：音声の冗長さを減らし、Codexが解釈しやすい命令文にする
	•	変換例：
	•	フィラー（えー、あの、）削除
	•	文末を命令形に寄せる
	•	重要語を箇条書き化
	•	追加できると強い：
	•	「制約」を検出して Constraints: セクションに寄せる
	•	「出力形式」を検出して Output: に寄せる

⸻

9. 実装ステップ（タスク分解）

Phase 1：動く最小（1日〜）
	1.	メニューバー常駐の土台（SwiftUI）
	2.	録音開始/停止（ファイル保存まで）
	3.	Whisper CLI を Process() で叩く（固定パスでOK）
	4.	結果をクリップボードに入れる
	5.	通知/ログ（成功・失敗）

Phase 2：使い物になる（+1〜2日）
	6.	ホットキー
	7.	自動ペースト（アクセシビリティ許可導線）
	8.	設定画面（最小）

Phase 3：Codex統合（+1〜2日）
	9.	Codex連携 B案を完成（貼り付け→Enterはユーザー）
	10.	A案 PoC（codex を起動し stdin に流す）
	11.	失敗時の復旧導線（クリップボードに残す等）

Phase 4：整形（任意）
	12.	PromptNormalizer を追加（ルールベースでOK）
	13.	モード切替

⸻

10. 受け入れ条件（Doneの定義）
	•	任意のテキスト入力欄でホットキー→録音→停止→文字が入る
	•	ターミナルで codex 起動中に同じ動作ができる
	•	失敗時に「何が失敗したか」わかる（権限/CLI不在/API失敗）

⸻

11. リスクと回避
	•	Whisper CLI の同梱/パス問題
→ v1は「ユーザーがパス指定」でも良い。後でバンドル検討。
	•	入力注入の権限が面倒
→ v1は「クリップボードのみ」でも成立。
	•	Codex CLI の仕様変更
→ A案は後回し、まず B案で価値を出す。

⸻

12. 次に決め打ちしたい（ここだけ決めれば実装に入れる）
	•	v1は Whisper CLI でいく？ API でいく？
	•	出力は クリップボードのみ？ 自動ペーストまでやる？
	•	Codex連携はまず **B案（貼り付け）**でOK？
